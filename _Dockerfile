# First stage: builder
FROM python:3.12 AS builder

# Install dependencies
RUN apt update && apt install -y build-essential curl git && apt clean

# Install the latest version of Rust and Cargo
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
ENV PATH="/root/.cargo/bin:${PATH}"

# Verify Rust installation
RUN rustup --version && rustc --version

# Create working directory
WORKDIR /passivbot

# Copy the current directory contents into the container at /passivbot
COPY . .

# Fix the rust-toolchain issue by updating it to stable
RUN if [ -f passivbot-rust/rust-toolchain ]; then echo "stable" > passivbot-rust/rust-toolchain; fi && \
    if [ -f passivbot-rust/rust-toolchain.toml ]; then echo -e "[toolchain]\nchannel = \"stable\"" > passivbot-rust/rust-toolchain.toml; fi

# Install Python dependencies
RUN --mount=type=cache,target=/root/.cache/pip pip install --upgrade pip
RUN --mount=type=cache,target=/root/.cache/pip pip install -r requirements.txt

# Build the Rust code with explicit toolchain override
RUN cd passivbot-rust && \
    rustup override set stable && \
    rustc --version && \
    maturin build --release && \
    pip install target/wheels/*.whl

# Second stage: final
FROM python:3.12

# Create working directory
WORKDIR /passivbot

# Copy only necessary files from builder
COPY --from=builder /usr/local/lib/python3.12/site-packages/ /usr/local/lib/python3.12/site-packages/
COPY --from=builder /passivbot/ ./

# Set working directory
WORKDIR /passivbot
