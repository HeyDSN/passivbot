# First stage: builder
FROM python:3.10 AS builder

# Install dependencies
RUN apt update && apt install -y build-essential curl git && apt clean

# Install the latest version of Rust and Cargo
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
ENV PATH="/root/.cargo/bin:${PATH}"

# Verify Rust installation
RUN rustup --version && rustc --version

# Create working directory
WORKDIR /passivbot

# Copy the current directory contents into the container at /passivbot
COPY . .

# Remove or update rust-toolchain file if it exists (this is what's causing the downgrade)
RUN rm -f passivbot-rust/rust-toolchain passivbot-rust/rust-toolchain.toml || true

# Install Python dependencies
RUN --mount=type=cache,target=/root/.cache/pip pip install --upgrade pip
RUN --mount=type=cache,target=/root/.cache/pip pip install -r requirements.txt

# Build the Rust code
RUN cd passivbot-rust && \
    maturin build --release && \
    pip install target/wheels/*.whl

# Second stage: final
FROM python:3.10

# Create working directory
WORKDIR /passivbot

# Copy only necessary files from builder
COPY --from=builder /usr/local/lib/python3.10/site-packages/ /usr/local/lib/python3.10/site-packages/
COPY --from=builder /passivbot/ ./

# Set working directory
WORKDIR /passivbot
